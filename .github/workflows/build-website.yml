name: Build website CI

on:
  push:
    branches: 
      - main
      - feature/tests

permissions: 
  contents: write
  pull-requests: write

jobs:
  build:
    concurrency: ci-${{ github.ref }}
    runs-on: ubuntu-latest
    steps:
      - name: Prepare dirs 
        run: |
          mkdir source
          mkdir build
      - name: Checkout source üõéÔ∏è
        uses: actions/checkout@v3
        with:
          path: ./source
      - name: Checkout gh-pages üõéÔ∏è
        uses: actions/checkout@v3
        with:
          path: ./build
          ref: gh-pages
      - name: Create branch
        run: git checkout -b "ci/website/${GITHUB_SHA::7}" "gh-pages"
        working-directory: ./build
      - name: Setup
        uses: pnpm/action-setup@v2.2.2
        with:
          version: 7.1.3
      - name: Install üîß
        working-directory: ./source/src
        run: pnpm i
      - name: Build üß™
        working-directory: ./source/src
        run: pnpm ci
      - name: Copy to build
        working-directory: ./source/src
        run: rsync -av dist/ ../../build
      - name: Check for changes üëÄ
        id: check-changes
        working-directory: ./build
        run: | 
          changes=$([[ `git status --porcelain` ]] && echo "true" || echo "false")
          echo "::set-output name=changes::$changes"
          echo "changes=$changes"
      - name: Deploy üöÄ
        if: ${{ steps.check-changes.outputs.changes == 'true' }}
        working-directory: ./build
        env:
          CI_NAME: ${{ secrets.BUILD_WEBSITE_CI_NAME }}
          CI_EMAIL: ${{ secrets.BUILD_WEBSITE_CI_EMAIL }}
        run: |
          echo "::group::Git config"
          git config user.name "$CI_NAME"
          git config user.email "$CI_EMAIL"
          git remote set-url origin https://x-access-token:${{ secrets.TOKEN }}@github.com/${{ github.repository }}
          echo "::endgroup::"
          echo "::group::Git add"
          git add -v .
          echo "::endgroup::"
          echo "::group::Git commit"
          git commit -m "feat(gp): deploy website"
          echo "::endgroup::"
          echo "::group::Git push"
          git push origin "ci/website/${GITHUB_SHA::7}"
          echo "::endgroup::"
          echo "::group::GitHub PR"
          echo "${{ secrets.TOKEN }}" | gh auth login --with-token
          gh pr create -t "CI Website deployment" -b "CI Website deployment for commit ${{ github.sha }} in branch ${{ github.ref_name }}." -r "$CI_EMAIL" -a "@me" -B "gh-pages" -l "CI"
          echo "::endgroup::"
      - name: Cleanup
        run: |
          rm -rf build
          rm -rf source
