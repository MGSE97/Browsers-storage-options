name: Build website CI

on:
  push:
    branches: 
      - main
      - feature/tests

permissions: 
  contents: write

jobs:
  build:
    concurrency: ci-${{ github.ref }}
    runs-on: ubuntu-latest
    steps:
      - name: Prepare dirs
        run: |
          mkdir source
          mkdir build
      - name: Checkout source üõéÔ∏è
        uses: actions/checkout@v3
        with:
          path: ./source
      - name: Checkout gh-pages üõéÔ∏è
        uses: actions/checkout@v3
        with:
          path: ./build
          ref: gh-pages
      - name: Setup
        uses: pnpm/action-setup@v2.2.2
        with:
          version: 7.1.3
      - name: Install
        working-directory: ./source/src
        run: pnpm i
      - name: Build
        working-directory: ./source/src
        run: pnpm ci
      - name: Copy to build
        working-directory: ./source/src
        run: cp -a dist/. ../../build/
      - name: Deploy üöÄ
        working-directory: ./build
        env:
          CI_NAME: ${{ secrets.BUILD_WEBSITE_CI_NAME }}
          CI_EMAIL: ${{ secrets.BUILD_WEBSITE_CI_EMAIL }}
        run: |
          git config user.name "$CI_NAME"
          git config user.email "$CI_EMAIL"
          git config commit.gpgsign true
          git remote set-url origin https://x-access-token:${{ secrets.TOKEN }}@github.com/${{ github.repository }}
          git commit -am "feat(gp): deploy website"
          git push
      - name: Cleanup
        run: |
          rm -rf build
          rm -rf source
